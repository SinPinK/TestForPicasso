{"version":3,"file":"helpers.js","names":["format","isValid","isWithinInterval","parse","IMask","useCallback","useEffect","useMemo","useState","useIMask","useMutableRef","leapYear","datePickerPropFormatTypeDate","datePickerPropSeparatorDefault","getPartsDate","datePickerErrorTypes","usePicker","props","value","onChange","onError","formatProp","separator","maxDate","minDate","onChangeRef","valueRef","onErrorRef","stringValue","setStringValue","stringValueRef","handleChange","e","current","dd","MM","yyyy","date","Date","start","end","type","getTime","options","mask","pattern","blocks","MaskedRange","from","to","lazy","autofix","string","validate","_val","params","maskOptions","inputRef","length","clearValue"],"sources":["../../../../../../src/components/DatePicker/DatePickerFieldTypeDate/helpers.ts"],"sourcesContent":["import { IconComponent, IconPropSize } from '@consta/icons/Icon';\nimport { format, isValid, isWithinInterval, parse } from 'date-fns';\nimport IMask from 'imask';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\n\nimport { useIMask } from '##/components/TextField';\n\nimport { useMutableRef } from '../../../hooks/useMutableRef/useMutableRef';\nimport { leapYear } from '../../../utils/date';\nimport { PropsWithHTMLAttributes } from '../../../utils/types/PropsWithHTMLAttributes';\nimport {\n  TextFieldPropForm,\n  TextFieldPropSize,\n  TextFieldPropStatus,\n  TextFieldPropView,\n  TextFieldPropWidth,\n} from '../../TextField/TextField';\nimport {\n  datePickerPropFormatTypeDate,\n  datePickerPropSeparatorDefault,\n  getPartsDate,\n} from '../helpers';\nimport { datePickerErrorTypes, DatePickerPropOnError } from '../types';\n\ntype DatePickerFieldTypeDatePropOnChange = (props: {\n  e: Event;\n  value: Date | null;\n}) => void;\n\nexport type DatePickerFieldTypeDateProps = PropsWithHTMLAttributes<\n  {\n    className?: string;\n    value?: Date | null;\n    onChange?: DatePickerFieldTypeDatePropOnChange;\n    onError?: DatePickerPropOnError;\n    id?: string;\n    name?: string;\n    disabled?: boolean;\n    size?: TextFieldPropSize;\n    view?: TextFieldPropView;\n    form?: TextFieldPropForm;\n    status?: TextFieldPropStatus;\n    width?: TextFieldPropWidth;\n    onFocus?: React.FocusEventHandler<HTMLElement>;\n    onBlur?: React.FocusEventHandler<HTMLElement>;\n    autoFocus?: boolean;\n    placeholder?: string;\n    leftSide?: string | IconComponent;\n    rightSide?: string | IconComponent;\n    readOnly?: boolean;\n    required?: boolean;\n    tabIndex?: number;\n    inputRef?: React.Ref<HTMLTextAreaElement | HTMLInputElement>;\n    ariaLabel?: string;\n    iconSize?: IconPropSize;\n    children?: never;\n    format?: string;\n    separator?: string;\n    minDate?: Date;\n    maxDate?: Date;\n    focused?: boolean;\n    label?: string;\n    labelIcon?: IconComponent;\n    caption?: string;\n    labelPosition?: 'top' | 'left';\n    withClearButton?: boolean;\n  },\n  HTMLDivElement\n>;\n\ntype UsePickerProps = {\n  value?: Date | null;\n  onChange?: DatePickerFieldTypeDatePropOnChange;\n  onError?: DatePickerPropOnError;\n  format: string;\n  separator: string;\n  minDate: Date;\n  maxDate: Date;\n};\n\nexport const usePicker = (props: UsePickerProps) => {\n  const {\n    value,\n    onChange,\n    onError,\n    format: formatProp,\n    separator,\n    maxDate,\n    minDate,\n  } = props;\n  const onChangeRef = useMutableRef(onChange);\n  const valueRef = useMutableRef(value);\n  const onErrorRef = useMutableRef(onError);\n\n  const [stringValue, setStringValue] = useState<string | null>(\n    value && isValid(value) ? format(value, formatProp) : null,\n  );\n  const stringValueRef = useMutableRef(stringValue);\n\n  const handleChange = useCallback(\n    ({ e, value: stringValue }: { e: Event; value: string | null }) => {\n      if (stringValueRef.current === stringValue) {\n        return;\n      }\n      setStringValue(stringValue);\n      const onChange = onChangeRef.current;\n      const value = valueRef.current;\n      if (onChange) {\n        if (!stringValue) {\n          if (value) {\n            onChange({ e, value: null });\n          }\n          return;\n        }\n        const [dd, MM, yyyy] = getPartsDate(\n          stringValue,\n          formatProp,\n          separator,\n          false,\n          ['dd', 'MM', 'yyyy'],\n        );\n        if (dd && MM && yyyy) {\n          const date = parse(\n            `${dd}${datePickerPropSeparatorDefault}${MM}${datePickerPropSeparatorDefault}${yyyy}`,\n            datePickerPropFormatTypeDate,\n            new Date(),\n          );\n          if (!isWithinInterval(date, { start: minDate, end: maxDate })) {\n            onErrorRef.current?.({\n              type: datePickerErrorTypes[0],\n              stringValue,\n              dd,\n              MM,\n              yyyy,\n              date,\n            });\n            if (value) {\n              onChange({ e, value: null });\n            }\n\n            return;\n          }\n          onChange({ e, value: date });\n        } else if (value) {\n          onChange({ e, value: null });\n        }\n      }\n    },\n    [minDate?.getTime(), maxDate?.getTime(), formatProp, separator],\n  );\n\n  const options: IMask.InputMask<IMask.MaskedDateOptions> = useMemo(\n    () =>\n      ({\n        mask: Date,\n        pattern: formatProp,\n        blocks: {\n          yyyy: {\n            mask: IMask.MaskedRange,\n            from: 1,\n            to: 9999,\n          },\n          MM: {\n            mask: IMask.MaskedRange,\n            from: 1,\n            to: 12,\n          },\n          dd: {\n            mask: IMask.MaskedRange,\n            from: 1,\n            to: 31,\n          },\n        },\n        lazy: true,\n        autofix: true,\n        format: (date: Date) => format(date, formatProp),\n        parse: (string: string) => parse(string, formatProp, new Date()),\n        validate: (string: string) => {\n          const [dd, MM, yyyy] = getPartsDate(\n            string,\n            formatProp,\n            separator,\n            false,\n            ['dd', 'MM', 'yyyy'],\n          );\n          if (\n            dd &&\n            MM &&\n            !isValid(\n              parse(\n                `${dd}${datePickerPropSeparatorDefault}${MM}${datePickerPropSeparatorDefault}${leapYear}`,\n                datePickerPropFormatTypeDate,\n                new Date(),\n              ),\n            )\n          ) {\n            onErrorRef.current?.({\n              type: datePickerErrorTypes[1],\n              stringValue: string,\n              dd,\n              MM,\n              yyyy,\n            });\n            return false;\n          }\n          if (\n            dd &&\n            MM &&\n            yyyy &&\n            !isValid(\n              parse(\n                `${dd}${datePickerPropSeparatorDefault}${MM}${datePickerPropSeparatorDefault}${yyyy}`,\n                datePickerPropFormatTypeDate,\n                new Date(),\n              ),\n            )\n          ) {\n            onErrorRef.current?.({\n              type: datePickerErrorTypes[1],\n              stringValue: string,\n              dd,\n              MM,\n              yyyy,\n            });\n            return false;\n          }\n          return true;\n        },\n        // проблема в типах IMask\n      } as unknown as IMask.InputMask<IMask.MaskedDateOptions>),\n    [formatProp, separator],\n  );\n\n  const { inputRef } = useIMask({\n    value: stringValue,\n    onChange: (_val, params) => handleChange?.(params),\n    maskOptions: options,\n  });\n\n  const clearValue = (e: Event) => {\n    setStringValue(null);\n    onChange?.({ e, value: null });\n  };\n\n  // при изменении value, нужно обновить stringValue\n  useEffect(() => {\n    if (value && isValid(value)) {\n      setStringValue(format(value, formatProp));\n    } else if (stringValue?.length === formatProp.length) {\n      // если количество введенных символов меньше чем в формате маски\n      // то не нужно мешать вводу с клавиатуры\n      // если дата была введена полностью и value пришел null,\n      // то можно считать что поле нуждается в очистке\n      setStringValue('');\n    }\n  }, [value?.getTime()]);\n\n  return {\n    stringValue,\n    inputRef,\n    clearValue,\n  };\n};\n"],"mappings":"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"}