{"version":3,"file":"withTooltip.js","names":["React","useEffect","useRef","useState","Tooltip","useForkRef","withTooltipPropMode","withTooltipPropModeDefault","appearTimeoutDefault","exitTimeoutDefault","closeFunctions","clearTooltips","currentRef","removeCurrent","current","timer","clearTimeout","index","findIndex","ref","splice","closeFunction","push","withTooltip","hocProps","Component","forwardRef","props","tooltipProps","tooltipPropsFromComponent","componentProps","mode","content","closeOnClickOutside","appearTimeout","exitTimeout","style","otherTooltipProps","visible","setVisible","componentRef","tooltipRef","clearRef","clearTimer","setExitTimer","setTimeout","setAppearTimer","onClick","e","onMouseEnter","onMouseLeave","onClickOutside","tooltipOnMouseEnter","tooltipOnMouseLeave","zIndex"],"sources":["../../../../../src/hocs/withTooltip/withTooltip.tsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\n\nimport {\n  Tooltip,\n  TooltipProps as TooltipComponentProps,\n} from '../../components/Tooltip/Tooltip';\nimport { useForkRef } from '../../hooks/useForkRef/useForkRef';\n\nexport const withTooltipPropMode = ['mouseover', 'click'] as const;\nexport const withTooltipPropModeDefault = withTooltipPropMode[0];\ntype WithTooltipPropMode = typeof withTooltipPropMode[number];\n\nexport const appearTimeoutDefault = 400;\nexport const exitTimeoutDefault = 200;\n\ntype ComponentProps = {\n  onClick?: (() => void) | React.EventHandler<React.MouseEvent>;\n  onMouseEnter?: (() => void) | React.MouseEventHandler;\n  onMouseLeave?: (() => void) | React.MouseEventHandler;\n};\n\nexport type TooltipProps = Omit<TooltipComponentProps, 'children' | 'ref'> & {\n  content?: React.ReactNode;\n  mode?: WithTooltipPropMode;\n  closeOnClickOutside?: boolean;\n  appearTimeout?: number;\n  exitTimeout?: number;\n};\n\ntype ClearTooltip = {\n  closeFunction?: () => void;\n  timer?: ReturnType<typeof setTimeout>;\n};\n\ntype ClearTooltipRef = React.MutableRefObject<ClearTooltip>;\n\nexport type WithTooltipProps<Props> = Omit<Props, 'tooltipProps'> & {\n  tooltipProps?: TooltipProps;\n};\n\nconst closeFunctions: ClearTooltipRef[] = [];\n// функция которая закроет все тултипы на странице кроме текущего с которым взаимодействует пользователь\nfunction clearTooltips(currentRef: ClearTooltipRef, removeCurrent?: boolean) {\n  if (removeCurrent) {\n    // удаляем только текущую функцию закрытия, нужна если компонент размонтируется\n    if (currentRef.current.timer) {\n      clearTimeout(currentRef.current.timer);\n    }\n    const index = closeFunctions.findIndex((ref) => ref === currentRef);\n    closeFunctions.splice(index, 1);\n  } else {\n    // закрываем все тултипы на странице кроме текущего с которым взаимодействует пользователь\n    for (const ref of closeFunctions) {\n      if (currentRef !== ref) {\n        if (ref.current.timer) {\n          clearTimeout(ref.current.timer);\n        }\n        if (ref.current.closeFunction) {\n          ref.current.closeFunction();\n        }\n      }\n    }\n    closeFunctions.splice(0);\n    closeFunctions.push(currentRef);\n  }\n}\n\nexport function withTooltip(hocProps?: TooltipProps) {\n  return function <\n    COMPONENT_TYPE extends\n      | React.ComponentType<React.PropsWithRef<ComponentProps>>\n      | ((props: ComponentProps) => React.ReactElement | null),\n    COMPONENT_PROPS extends ComponentProps,\n  >(Component: COMPONENT_TYPE) {\n    return React.forwardRef<HTMLElement, WithTooltipProps<COMPONENT_PROPS>>(\n      (props, ref) => {\n        const {\n          tooltipProps: tooltipPropsFromComponent = {},\n          ...componentProps\n        } = props;\n        const tooltipProps: TooltipProps = {\n          ...hocProps,\n          ...tooltipPropsFromComponent,\n        };\n        const {\n          mode = 'mouseover',\n          content,\n          closeOnClickOutside = true,\n          appearTimeout = appearTimeoutDefault,\n          exitTimeout = exitTimeoutDefault,\n          style,\n          ...otherTooltipProps\n        } = tooltipProps;\n\n        const [visible, setVisible] = useState<boolean>(false);\n        const componentRef = useRef<HTMLElement | null>(null);\n        const tooltipRef = useRef<HTMLDivElement | null>(null);\n        const clearRef = useRef<ClearTooltip>({});\n\n        const clearTimer = () => {\n          if (clearRef.current.timer) {\n            clearTimeout(clearRef.current.timer);\n          }\n        };\n\n        const setExitTimer = () => {\n          if (mode === 'mouseover' && visible) {\n            clearRef.current.timer = setTimeout(\n              () => setVisible(false),\n              exitTimeout,\n            );\n          }\n        };\n\n        const setAppearTimer = () => {\n          if (mode === 'mouseover' && !visible) {\n            clearRef.current.timer = setTimeout(\n              () => setVisible(true),\n              appearTimeout,\n            );\n          }\n        };\n\n        useEffect(() => {\n          // очищаем ссылку в clearTooltips при размонтировании компонента\n          return () => clearTooltips(clearRef, true);\n        }, []);\n\n        useEffect(() => {\n          if (visible) {\n            clearRef.current.closeFunction = () => setVisible(false);\n            clearTooltips(clearRef);\n          }\n        }, [visible]);\n\n        const onClick = (e: React.MouseEvent) => {\n          if (mode === 'click') {\n            setVisible(!visible);\n          }\n          if (props.onClick) {\n            props?.onClick(e);\n          }\n        };\n\n        const onClickOutside = () => {\n          if (mode === 'click' && closeOnClickOutside) {\n            setVisible(false);\n          }\n        };\n\n        const onMouseEnter = (e: React.MouseEvent) => {\n          if (mode === 'mouseover') {\n            clearTimer();\n            setAppearTimer();\n          }\n\n          if (props.onMouseEnter) {\n            props.onMouseEnter(e);\n          }\n        };\n\n        const onMouseLeave = (e: React.MouseEvent) => {\n          clearTimer();\n          setExitTimer();\n          if (props.onMouseLeave) {\n            props.onMouseLeave(e);\n          }\n        };\n\n        const tooltipOnMouseEnter = (e: React.MouseEvent<HTMLDivElement>) => {\n          clearTimer();\n          if (otherTooltipProps.onMouseEnter) {\n            otherTooltipProps.onMouseEnter(e);\n          }\n        };\n\n        const tooltipOnMouseLeave = (e: React.MouseEvent<HTMLDivElement>) => {\n          clearTimer();\n          setExitTimer();\n          if (otherTooltipProps.onMouseLeave) {\n            otherTooltipProps.onMouseLeave(e);\n          }\n        };\n\n        const Anchor = Component as React.ComponentType<COMPONENT_PROPS>;\n\n        return (\n          <>\n            <Anchor\n              {...(componentProps as COMPONENT_PROPS)}\n              onClick={onClick}\n              onMouseEnter={onMouseEnter}\n              onMouseLeave={onMouseLeave}\n              ref={useForkRef([componentRef, ref])}\n              style={style}\n            />\n            {visible && (\n              <Tooltip\n                {...otherTooltipProps}\n                ref={tooltipRef}\n                anchorRef={componentRef}\n                onClickOutside={onClickOutside}\n                onMouseEnter={tooltipOnMouseEnter}\n                onMouseLeave={tooltipOnMouseLeave}\n                style={\n                  typeof style?.zIndex === 'number'\n                    ? { zIndex: style.zIndex + 1 }\n                    : undefined\n                }\n              >\n                {content}\n              </Tooltip>\n            )}\n          </>\n        );\n        // привел к типам, так как прокинутый компонент может иметь джененрики и они потеряются за хоком\n      },\n    ) as unknown as\n      | COMPONENT_TYPE\n      | React.ComponentType<WithTooltipProps<COMPONENT_PROPS>>;\n  };\n}\n"],"mappings":"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"}